# ๐ง ุฅุตูุงุญ ูุดููุฉ ุนุฏู ุญูุธ ุงูุนููุงุก ูู Firebase

## ๐ ุงููุดููุฉ

ุนูุฏ ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ ูู ูุงุฌูุฉ ุงูุชุทุจููุ ูุงู ุงูุนููู ููุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ (SQLite) ููุทุ ููุง ูุชู ูุฒุงููุชู ูุน Firebase Firestore.

### ุงูุณุจุจ ุงูุฌุฐุฑู

ูุงูุช ุดุงุดุฉ ุฅุถุงูุฉ ุงูุนููุงุก (`add_customer_screen.dart`) ุชุณุชุฎุฏู `CustomerService.addCustomerLocal()` ุจุฏูุงู ูู `CustomerRepository.addCustomer()`.

**ุงููุฑู ุจูู ุงูุฏุงูุชูู:**

| ุงูุฏุงูุฉ                               | ุงููุธููุฉ                                                                  | ุงููุฒุงููุฉ ูุน Firebase |
| ------------------------------------ | ------------------------------------------------------------------------ | -------------------- |
| `CustomerService.addCustomerLocal()` | โ ุญูุธ ูู SQLite<br>โ ูุง ุชุถุน `pendingSync = 1`<br>โ ูุง ุชุณุชุฏุนู ุงููุฒุงููุฉ | โ ูุง                |
| `CustomerRepository.addCustomer()`   | โ ุญูุธ ูู SQLite<br>โ ุชุถุน `pendingSync = 1`<br>โ ุชุณุชุฏุนู `_trySync()`   | โ ูุนู               |

---

## โ ุงูุญู ุงููุทุจู

### 1. ุชุนุฏูู `add_customer_screen.dart`

**ูุจู:**

```dart
import '../services/customer_service.dart';

// ูู ุฏุงูุฉ _addCustomer():
final customerService = Provider.of<CustomerService>(context, listen: false);
await customerService.addCustomerLocal({
  'name': _nameController.text.trim(),
  // ...
});
```

**ุจุนุฏ:**

```dart
import '../repositories/customer_repository.dart';
import '../models/customer_model.dart';

// ูู ุฏุงูุฉ _addCustomer():
final customerRepo = Provider.of<CustomerRepository>(context, listen: false);

final newCustomer = Customer(
  id: DateTime.now().millisecondsSinceEpoch.toString(),
  name: _nameController.text.trim(),
  address: _addressController.text.trim(),
  phone: _phoneController.text.trim(),
  meterNumber: _meterNumberController.text.trim(),
  lastReading: double.parse(_initialReadingController.text),
  lastReadingDate: DateTime.now().toIso8601String(),
  status: 'active',
  createdAt: DateTime.now().toIso8601String(),
  lastModified: DateTime.now().toIso8601String(),
  pendingSync: 1, // ุณูุชู ุงููุฒุงููุฉ ูุน Firebase
  deleted: 0,
);

await customerRepo.addCustomer(newCustomer);
```

---

## ๐ ููู ุชุนูู ุงููุฒุงููุฉ ุงูุขู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  1. ุงููุณุชุฎุฏู ูุถูู ุนููู ุฌุฏูุฏ ูู ุงููุงุฌูุฉ              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  2. customerRepo.addCustomer(newCustomer)           โ
โ     - ุญูุธ ูู SQLite ูุน pendingSync = 1              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  3. _trySync() ูุชู ุงุณุชุฏุนุงุคูุง ุชููุงุฆูุงู               โ
โ     - ูุญุต ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  4. ุฅุฐุง ูุงู ููุงู ุงุชุตุงู:                            โ
โ     _pushLocalChanges() ุชุฑูุน ุงูุจูุงูุงุช ุฅูู Firebase โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  5. Firebase Firestore ูุญูุธ ุงูุนููู ุงูุฌุฏูุฏ           โ
โ     - ุชุญุฏูุซ pendingSync = 0 ูู SQLite              โ
โ     - ุชุญุฏูุซ lastSyncedAt                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

### 1. ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ

- ุนูุฏ ุฅุถุงูุฉ ุนููู ุฌุฏูุฏุ ูุชู ุญูุธู ูุญููุงู ุฃููุงู ูุน `pendingSync = 1`
- ุฅุฐุง ูุงู ููุงู ุงุชุตุงู ุจุงูุฅูุชุฑูุชุ ูุชู ุฑูุนู ุฅูู Firebase ููุฑุงู
- ุฅุฐุง ูู ููู ููุงู ุงุชุตุงูุ ุณูุชู ุฑูุนู ุนูุฏ ุนูุฏุฉ ุงูุงุชุตุงู

### 2. ุงูุดุงุดุงุช ุงููุฎุชููุฉ

| ุงูุดุงุดุฉ                         | ุงูุญุงูุฉ                   |
| ------------------------------ | ------------------------ |
| `add_customer_screen.dart`     | โ ุชู ุฅุตูุงุญูุง            |
| `add_customer_screen_new.dart` | โ ูุงูุช ุตุญูุญุฉ ูู ุงูุจุฏุงูุฉ |

### 3. CustomerService vs CustomerRepository

**ูุชู ุชุณุชุฎุฏู `CustomerService`:**

- ุนูุฏ ุงูุญุงุฌุฉ ููุชุนุงูู ูุน Firebase ูุจุงุดุฑุฉ ููุท
- ูู ุญุงูุงุช ุฎุงุตุฉ ูุง ุชุญุชุงุฌ ูุฒุงููุฉ

**ูุชู ุชุณุชุฎุฏู `CustomerRepository`:** โญ (ููุตู ุจู)

- ูู ุฌููุน ุนูููุงุช CRUD ุงูุนุงุฏูุฉ
- ุนูุฏูุง ุชุฑูุฏ ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ
- ููุญุตูู ุนูู Offline-First functionality

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ:

1. **ุงูุชุญ ุงูุชุทุจูู**
2. **ุฃุถู ุนููู ุฌุฏูุฏ** ูู ุดุงุดุฉ ุฅุถุงูุฉ ุงูุนููู
3. **ุชุญูู ูู SQLite:**
   ```dart
   // ูุฌุจ ุฃู ูููู pendingSync = 1 ูู ุงูุจุฏุงูุฉ
   ```
4. **ุชุญูู ูู Firebase Console:**
   - ุงูุชุญ Firebase Console โ Firestore
   - ูุฌุจ ุฃู ุชุฑู ุงูุนููู ุงูุฌุฏูุฏ ูู collection `customers`
5. **ุชุญูู ูู SQLite ูุฑุฉ ุฃุฎุฑู:**
   ```dart
   // ูุฌุจ ุฃู ูุตุจุญ pendingSync = 0 ุจุนุฏ ุงููุฒุงููุฉ
   ```

### ุงุฎุชุจุงุฑ ุจุฏูู ุงุชุตุงู:

1. **ุงูุตู ุงูุฅูุชุฑูุช**
2. **ุฃุถู ุนููู ุฌุฏูุฏ**
3. **ุชุญูู:** ุงูุนููู ูุญููุธ ูุญููุงู ูุน `pendingSync = 1`
4. **ุฃุนุฏ ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช**
5. **ุงูุชุธุฑ ููููุงู** (ุฃู ุงูุชุญ ุดุงุดุฉ ุงูุงุฎุชุจุงุฑ ูุงุถุบุท "ูุฒุงููุฉ ูุฏููุฉ")
6. **ุชุญูู ูู Firebase:** ูุฌุจ ุฃู ูุธูุฑ ุงูุนููู ุงูุขู

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ุงูุนููู ูุง ูุธูุฑ ูู Firebase

**ุงูุญููู:**

1. **ุชุญูู ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช:**

   ```dart
   // ูู ุดุงุดุฉ ุงูุงุฎุชุจุงุฑุ ุงุถุบุท "ูุญุต ุงูุงุชุตุงู"
   ```

2. **ุชุญูู ูู pendingSync:**

   ```dart
   // ุงูุชุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุชุญูู ูู ูููุฉ pendingSync
   // ุฅุฐุง ูุงูุช 1ุ ูุนูุงูุง ูู ุชุชู ุงููุฒุงููุฉ ุจุนุฏ
   ```

3. **ุชุญูู ูู Console Logs:**

   ```
   ๐ [CustomerRepo] ุจุฏุก ุฑูุน ุงูุชุบููุฑุงุช ุงููุญููุฉ...
   โ [CustomerRepo] ุชู ุฑูุน ุนููู: [ุงุณู ุงูุนููู]
   ```

4. **ูุฒุงููุฉ ูุฏููุฉ:**
   - ุงูุชุญ ุดุงุดุฉ ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ
   - ุงุถุบุท "ูุฒุงููุฉ ูุฏููุฉ"

### ุงููุดููุฉ: ุฎุทุฃ ุนูุฏ ุงูุฅุถุงูุฉ

**ุชุญูู ูู:**

1. **Firebase Rules:** ุชุฃูุฏ ูู ุฃู ููุงุนุฏ Firestore ุชุณูุญ ุจุงููุชุงุจุฉ
2. **Authentication:** ุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู (ุฅุฐุง ูุงูุช ุงูููุงุนุฏ ุชุชุทูุจ ุฐูู)
3. **Internet Permission:** ุชุฃูุฏ ูู ุฃู ุงูุชุทุจูู ูุฏูู ุตูุงุญูุฉ ุงูุฅูุชุฑูุช

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

| ุงูููู                                      | ุงูุชุนุฏูู          | ุงูุณุจุจ                                         |
| ------------------------------------------ | ---------------- | --------------------------------------------- |
| `lib/screens/add_customer_screen.dart`     | โ ุชู ุชุนุฏููู     | ุงุณุชุจุฏุงู CustomerService ุจู CustomerRepository |
| `lib/screens/add_customer_screen_new.dart` | โช ูู ูุชู ุชุนุฏููู | ูุงู ูุณุชุฎุฏู CustomerRepository ุจุงููุนู          |

---

## ๐ฏ ุงููุชูุฌุฉ

| ูุจู                             | ุจุนุฏ                       |
| ------------------------------- | ------------------------- |
| โ ุงูุนููุงุก ูุง ุชูุญูุธ ูู Firebase | โ ุงูุนููุงุก ุชูุญูุธ ุชููุงุฆูุงู |
| โ ูุง ุชูุฌุฏ ูุฒุงููุฉ               | โ ูุฒุงููุฉ ุชููุงุฆูุฉ         |
| โ ุงูุจูุงูุงุช ูุญููุฉ ููุท           | โ ุงูุจูุงูุงุช ูุชุฒุงููุฉ       |
| โ ูุง ูุนูู Offline-First        | โ ูุนูู Offline-First     |

---

## ๐ ูุฑุงุฌุน ุฐุงุช ุตูุฉ

- **TIMESTAMP_FIX.md** - ุฅุตูุงุญ ูุดููุฉ Timestamp
- **SCHEMA_MISMATCH_FIX.md** - ุฅุตูุงุญ ูุดููุฉ ุนุฏู ุชุทุงุจู ุงูุจููุฉ
- **COMPLETE_FIX_SUMMARY.md** - ููุฎุต ุดุงูู ูุฌููุน ุงูุฅุตูุงุญุงุช
- **QUICK_TEST_GUIDE.md** - ุฏููู ุงูุงุฎุชุจุงุฑ ุงูุณุฑูุน

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 2024  
**ุงูุญุงูุฉ:** โ ููุชูู  
**ุงูุฃููููุฉ:** ๐ด ุนุงููุฉ (Critical)
