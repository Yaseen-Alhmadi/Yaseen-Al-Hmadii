# ๐ ุฏููู ุฅุนุฏุงุฏ Firestore Indexes

## ๐ฏ ุงููุฏู

ุฅูุดุงุก **Composite Indexes** ูู Firestore ูุชูููู ุงูุงุณุชุนูุงูุงุช ุงููุนูุฏุฉ ุงูุชู ุชุณุชุฎุฏู `where()` + `orderBy()`.

---

## ๐จ ุงููุดููุฉ

ุนูุฏ ุชุดุบูู ุงูุชุทุจููุ ุชุธูุฑ ูุฐู ุงูุฃุฎุทุงุก ูู ุงูู logs:

```
[Firestore]: Listen for Query(invoices where userId==... order by -issueDate) failed:
Status{code=FAILED_PRECONDITION, description=The query requires an index...}
```

```
[Firestore]: Listen for Query(meter_readings where userId==... order by -readingDate) failed:
Status{code=FAILED_PRECONDITION, description=The query requires an index...}
```

**ุงูุณุจุจ:** Firestore ูุชุทูุจ Indexes ูุฎุตุตุฉ ููุงุณุชุนูุงูุงุช ุงูุชู ุชุฌูุน ุจูู `where()` ู `orderBy()` ุนูู ุญููู ูุฎุชููุฉ.

---

## โ ุงูุญู (3 ุทุฑู)

### **ุงูุทุฑููุฉ 1: ุงุณุชุฎุฏุงู ุงูุฑูุงุจุท ุงููุจุงุดุฑุฉ (ุงูุฃุณุฑุน) โก**

ุนูุฏ ุธููุฑ ุงูุฎุทุฃ ูู ุงูู logsุ ุงูุณุฎ ุงูุฑุงุจุท ุงูููุนุทู ูุงูุตูู ูู ุงููุชุตูุญ:

#### **1. Index ููููุงุชูุฑ (Invoices):**

```
https://console.firebase.google.com/v1/r/project/water-management-system-d059c/firestore/indexes?create_composite=...
```

#### **2. Index ูููุฑุงุกุงุช (Meter Readings):**

```
https://console.firebase.google.com/v1/r/project/water-management-system-d059c/firestore/indexes?create_composite=...
```

**ุงูุฎุทูุงุช:**

1. ุงููุฑ ุนูู ุงูุฑุงุจุท
2. ุณููุชุญ Firebase Console ูุน ุงูู Index ุฌุงูุฒ
3. ุงุถุบุท **Create Index**
4. ุงูุชุธุฑ ุญุชู ููุชูู ุงูุจูุงุก (1-5 ุฏูุงุฆู)

---

### **ุงูุทุฑููุฉ 2: ุฅูุดุงุก ูุฏูู ูู Firebase Console ๐ฑ๏ธ**

#### **ุงูุฎุทูุฉ 1: ุงูุชุญ Firebase Console**

1. ุงุฐูุจ ุฅูู: https://console.firebase.google.com/
2. ุงุฎุชุฑ ูุดุฑูุน: **water-management-system-d059c**
3. ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ: **Firestore Database** โ **Indexes**

#### **ุงูุฎุทูุฉ 2: ุฃุถู Index ููููุงุชูุฑ**

1. ุงุถุบุท **Create Index**
2. ุงููุฃ ุงูุจูุงูุงุช:
   - **Collection ID:** `invoices`
   - **Fields:**
     - Field: `userId` โ Order: **Ascending**
     - Field: `issueDate` โ Order: **Descending**
     - Field: `__name__` โ Order: **Descending** (ููุถุงู ุชููุงุฆูุงู)
3. ุงุถุบุท **Create**

#### **ุงูุฎุทูุฉ 3: ุฃุถู Index ูููุฑุงุกุงุช**

1. ุงุถุบุท **Create Index**
2. ุงููุฃ ุงูุจูุงูุงุช:
   - **Collection ID:** `meter_readings`
   - **Fields:**
     - Field: `userId` โ Order: **Ascending**
     - Field: `readingDate` โ Order: **Descending**
     - Field: `__name__` โ Order: **Descending** (ููุถุงู ุชููุงุฆูุงู)
3. ุงุถุบุท **Create**

#### **ุงูุฎุทูุฉ 4 (ุงุฎุชูุงุฑู): ุฃุถู Index ููุนููุงุก**

1. ุงุถุบุท **Create Index**
2. ุงููุฃ ุงูุจูุงูุงุช:
   - **Collection ID:** `customers`
   - **Fields:**
     - Field: `userId` โ Order: **Ascending**
     - Field: `name` โ Order: **Ascending**
3. ุงุถุบุท **Create**

---

### **ุงูุทุฑููุฉ 3: ุงุณุชุฎุฏุงู Firebase CLI (ูููุทูุฑูู) ๐ป**

#### **ุงูุฎุทูุฉ 1: ุชุซุจูุช Firebase CLI**

```bash
npm install -g firebase-tools
```

#### **ุงูุฎุทูุฉ 2: ุชุณุฌูู ุงูุฏุฎูู**

```bash
firebase login
```

#### **ุงูุฎุทูุฉ 3: ุชููุฆุฉ ุงููุดุฑูุน**

```bash
cd c:\Users\lenovo\Desktop\Tetse\tests1\water_management_system
firebase init firestore
```

**ุงุฎุชุฑ:**

- โ Use an existing project: **water-management-system-d059c**
- โ Firestore Rules: `firestore.rules`
- โ Firestore Indexes: `firestore.indexes.json`

#### **ุงูุฎุทูุฉ 4: ุฑูุน ุงูู Indexes**

```bash
firebase deploy --only firestore:indexes
```

**ุงููุชูุฌุฉ:**

```
โ Deploy complete!
Indexes are being built...
```

#### **ุงูุฎุทูุฉ 5: ุงูุชุญูู ูู ุงูุญุงูุฉ**

```bash
firebase firestore:indexes
```

---

## ๐ ุงูู Indexes ุงููุทููุจุฉ

### **1. Index ููููุงุชูุฑ (invoices)**

| Field       | Order      | ุงูุบุฑุถ                               |
| ----------- | ---------- | ----------------------------------- |
| `userId`    | Ascending  | ููุชุฑุฉ ุงูููุงุชูุฑ ุญุณุจ ุงููุณุชุฎุฏู         |
| `issueDate` | Descending | ุชุฑุชูุจ ุงูููุงุชูุฑ ูู ุงูุฃุญุฏุซ ุฅูู ุงูุฃูุฏู |
| `__name__`  | Descending | ุถูุงู ุชุฑุชูุจ ุซุงุจุช (ููุถุงู ุชููุงุฆูุงู)    |

**ุงูุงุณุชุนูุงู ุงูููุณุชุฎุฏู:**

```dart
_firestore
  .collection('invoices')
  .where('userId', isEqualTo: userId)
  .orderBy('issueDate', descending: true)
```

---

### **2. Index ูููุฑุงุกุงุช (meter_readings)**

| Field         | Order      | ุงูุบุฑุถ                               |
| ------------- | ---------- | ----------------------------------- |
| `userId`      | Ascending  | ููุชุฑุฉ ุงููุฑุงุกุงุช ุญุณุจ ุงููุณุชุฎุฏู         |
| `readingDate` | Descending | ุชุฑุชูุจ ุงููุฑุงุกุงุช ูู ุงูุฃุญุฏุซ ุฅูู ุงูุฃูุฏู |
| `__name__`    | Descending | ุถูุงู ุชุฑุชูุจ ุซุงุจุช (ููุถุงู ุชููุงุฆูุงู)    |

**ุงูุงุณุชุนูุงู ุงูููุณุชุฎุฏู:**

```dart
_firestore
  .collection('meter_readings')
  .where('userId', isEqualTo: userId)
  .orderBy('readingDate', descending: true)
```

---

### **3. Index ููุนููุงุก (customers) - ุงุฎุชูุงุฑู**

| Field    | Order     | ุงูุบุฑุถ                      |
| -------- | --------- | -------------------------- |
| `userId` | Ascending | ููุชุฑุฉ ุงูุนููุงุก ุญุณุจ ุงููุณุชุฎุฏู |
| `name`   | Ascending | ุชุฑุชูุจ ุงูุนููุงุก ุฃุจุฌุฏูุงู      |

**ุงูุงุณุชุนูุงู ุงูููุณุชุฎุฏู:**

```dart
_firestore
  .collection('customers')
  .where('userId', isEqualTo: userId)
  .orderBy('name')
```

---

## โฑ๏ธ ูุฏุฉ ุจูุงุก ุงูู Indexes

| ุนุฏุฏ ุงูุณุฌูุงุช | ุงููุฏุฉ ุงููุชููุนุฉ |
| ----------- | -------------- |
| 0 - 100     | 1-2 ุฏูููุฉ      |
| 100 - 1000  | 2-5 ุฏูุงุฆู      |
| 1000+       | 5-15 ุฏูููุฉ     |

**ููุงุญุธุฉ:** ููููู ุงุณุชุฎุฏุงู ุงูุชุทุจูู ุฃุซูุงุก ุจูุงุก ุงูู Indexesุ ููู ุงูุงุณุชุนูุงูุงุช ุงูููุนุชูุฏุฉ ุนูููุง ูู ุชุนูู ุญุชู ููุชูู ุงูุจูุงุก.

---

## ๐งช ุงูุชุญูู ูู ูุฌุงุญ ุงูุฅุนุฏุงุฏ

### **1. ูู Firebase Console:**

1. ุงุฐูุจ ุฅูู: **Firestore Database** โ **Indexes**
2. ุชุญูู ูู ุฃู ุฌููุน ุงูู Indexes ูู ุญุงูุฉ **Enabled** (ูููุณ Building)

### **2. ูู ุงูุชุทุจูู:**

1. ุดุบู ุงูุชุทุจูู: `flutter run`
2. ุงูุชุญ ุดุงุดุฉ **ุงูููุงุชูุฑ** ุฃู **ุงููุฑุงุกุงุช**
3. ุชุญูู ูู ุงูู logs - ูุฌุจ ุฃูุง ุชุธูุฑ ุฃุฎุทุงุก `FAILED_PRECONDITION`

### **3. ูู ุงูู Logs:**

**ูุจู:**

```
[Firestore]: Listen for Query(...) failed: Status{code=FAILED_PRECONDITION...}
```

**ุจุนุฏ:**

```
โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก - ุงูุจูุงูุงุช ุชูุญูู ุจูุฌุงุญ
```

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### **ุงููุดููุฉ 1: "Index is still building"**

**ุงูุญู:** ุงูุชุธุฑ ุจุถุน ุฏูุงุฆู ุญุชู ููุชูู ุงูุจูุงุก.

### **ุงููุดููุฉ 2: "Permission denied"**

**ุงูุญู:** ุชุฃูุฏ ูู ุฃูู ูุณุฌู ุฏุฎูู ุจุญุณุงุจ ูู ุตูุงุญูุงุช ุนูู ุงููุดุฑูุน.

### **ุงููุดููุฉ 3: "Index already exists"**

**ุงูุญู:** ุงูู Index ููุฌูุฏ ุจุงููุนู - ูุง ุญุงุฌุฉ ูุฅูุดุงุฆู ูุฑุฉ ุฃุฎุฑู.

### **ุงููุดููุฉ 4: ุงูุงุณุชุนูุงู ูุง ูุฒุงู ููุดู ุจุนุฏ ุฅูุดุงุก ุงูู Index**

**ุงูุญู:**

1. ุชุญูู ูู ุฃู ุงูู Index ูู ุญุงูุฉ **Enabled**
2. ุฃุนุฏ ุชุดุบูู ุงูุชุทุจูู
3. ุชุญูู ูู ุฃู ุงูุงุณุชุนูุงู ูุทุงุจู ุงูู Index ุชูุงูุงู (ููุณ ุงูุญููู ูููุณ ุงูุชุฑุชูุจ)

---

## ๐ ูููุงุช ุฐุงุช ุตูุฉ

| ุงูููู                      | ุงููุตู                                |
| -------------------------- | ------------------------------------ |
| `firestore.indexes.json`   | ุชุนุฑูู ุงูู Indexes (ููู Firebase CLI) |
| `firestore.rules`          | ููุงุนุฏ ุงูุฃูุงู (ุฅู ููุฌุฏุช)              |
| `invoice_service.dart`     | ุงูุงุณุชุนูุงูุงุช ุนูู ุฌุฏูู ุงูููุงุชูุฑ        |
| `reading_service.dart`     | ุงูุงุณุชุนูุงูุงุช ุนูู ุฌุฏูู ุงููุฑุงุกุงุช        |
| `customer_repository.dart` | ุงูุงุณุชุนูุงูุงุช ุนูู ุฌุฏูู ุงูุนููุงุก         |

---

## ๐ฏ ุงูุฎูุงุตุฉ

โ **ูุง ุชู:**

- ุฅูุดุงุก ููู `firestore.indexes.json` ูุญุชูู ุนูู ุฌููุน ุงูู Indexes ุงููุทููุจุฉ
- ุชูุซูู 3 ุทุฑู ูุฅูุดุงุก ุงูู Indexes (ุฑูุงุจุท ูุจุงุดุฑุฉุ ูุฏููุ CLI)
- ุดุฑุญ ุณุจุจ ุงูุญุงุฌุฉ ููู Index

โ **ุงูุฎุทูุฉ ุงูุชุงููุฉ:**

1. ุงุฎุชุฑ ุฅุญุฏู ุงูุทุฑู ุงูุซูุงุซ ูุฅูุดุงุก ุงูู Indexes
2. ุงูุชุธุฑ ุญุชู ููุชูู ุงูุจูุงุก (1-5 ุฏูุงุฆู)
3. ุฃุนุฏ ุชุดุบูู ุงูุชุทุจูู
4. ุชุญูู ูู ุงุฎุชูุงุก ุงูุฃุฎุทุงุก

โ **ุงููุงุฆุฏุฉ:**

- ๐ ุงุณุชุนูุงูุงุช ุฃุณุฑุน (10x-100x)
- โ ุฏุนู ุงูููุชุฑุฉ ูุงูุชุฑุชูุจ ุงููุนูุฏ
- ๐ ุชุญููู ุงูุจูุงูุงุช ุจููุงุกุฉ ุนุงููุฉ

---

## ๐ ูููุณุงุนุฏุฉ

ุฅุฐุง ูุงุฌูุช ุฃู ูุดููุฉ:

1. ุชุญูู ูู ูุณู "ุงุณุชูุดุงู ุงูุฃุฎุทุงุก" ุฃุนูุงู
2. ุฑุงุฌุน ุงูู logs ูู ุงูุชุทุจูู
3. ุชุญูู ูู ุญุงูุฉ ุงูู Indexes ูู Firebase Console

---

**ุขุฎุฑ ุชุญุฏูุซ:** ${new Date().toISOString().split('T')[0]}
