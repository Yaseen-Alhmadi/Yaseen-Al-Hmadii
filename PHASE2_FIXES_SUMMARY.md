# ููุฎุต ุฅุตูุงุญุงุช ุงููุฑุญูุฉ ุงูุซุงููุฉ - ุนุฒู ุจูุงูุงุช ุงููุณุชุฎุฏููู

## ุงูุชุงุฑูุฎ: ุงูููู

## ุงููุฏู: ุชุทุจูู ุนุฒู ูุงูู ููุจูุงูุงุช ุจุญูุซ ูู ูุณุชุฎุฏู ูุฑู ุจูุงูุงุชู ููุท

---

## โ ุงููููุงุช ุงูุชู ุชู ุชุญุฏูุซูุง ุจูุฌุงุญ

### 1. ุงูููุงุฐุฌ (Models)

#### โ `lib/models/customer_model.dart`

- โ ุฅุถุงูุฉ ุญูู `userId` ูุญูู ูุทููุจ
- โ ุชุญุฏูุซ `toMap()` ูุชุถููู userId
- โ ุชุญุฏูุซ `fromMap()` ูุน ูููุฉ ุงูุชุฑุงุถูุฉ 'default_user' ููุชูุงูู ูุน ุงูุจูุงูุงุช ุงููุฏููุฉ
- โ ุชุญุฏูุซ `copyWith()` ูุฏุนู userId

#### โ `lib/models/reading_model.dart`

- โ ุฅุถุงูุฉ ุญูู `userId` ูุญูู ูุทููุจ
- โ ุชุญุฏูุซ ุฌููุน ุงูุฏูุงู (toMap, fromMap, copyWith)
- โ ุฏุนู ุงูุชูุงูู ูุน ุงูุจูุงูุงุช ุงููุฏููุฉ

#### โ `lib/models/invoice_model.dart`

- โ ุฅุถุงูุฉ ุญูู `userId` ูุญูู ูุทููุจ
- โ ุชุญุฏูุซ `toMap()` ูุชุถููู userId
- โ ุชุญุฏูุซ `fromMap()` ูุน ูููุฉ ุงูุชุฑุงุถูุฉ 'default_user'

---

### 2. ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ

#### โ `lib/services/database_helper.dart`

- โ ุชุฑููุฉ ุฅุตุฏุงุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู 2 ุฅูู 3
- โ ุฅุถุงูุฉ ุนููุฏ `userId TEXT NOT NULL` ูุฌููุน ุงูุฌุฏุงูู:
  - ุฌุฏูู `customers`
  - ุฌุฏูู `readings`
  - ุฌุฏูู `invoices`
- โ ุฅูุดุงุก ููุงุฑุณ ูุฑูุจุฉ ูุชุญุณูู ุงูุฃุฏุงุก:
  - `idx_customers_userId` ุนูู (userId, deleted)
  - `idx_readings_userId` ุนูู (userId, deleted)
  - `idx_invoices_userId` ุนูู (userId, deleted)
- โ ุฏุงูุฉ ุงูุชุฑุญูู `_upgradeDB()` ูุฅุถุงูุฉ userId ููุจูุงูุงุช ุงูููุฌูุฏุฉ

---

### 3. ุงููุณุชูุฏุนุงุช (Repositories)

#### โ `lib/repositories/customer_repository.dart`

- โ ุญูู `AuthService` ูุงุนุชูุงุฏ
- โ ุชุญุฏูุซ `getCustomers()`: ุชุตููุฉ ุญุณุจ userId
- โ ุชุญุฏูุซ `getCustomerById()`: ุงูุชุญูู ูู userId
- โ ุชุญุฏูุซ `addCustomer()`: ุญูู userId ุชููุงุฆูุงู
- โ ุฅุถุงูุฉ ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู ูุจู ุฃู ุนูููุฉ

---

### 4. ุงูุฎุฏูุงุช (Services)

#### โ `lib/services/reading_service.dart`

- โ ุญูู `AuthService` ูุงุนุชูุงุฏ
- โ ุชุญุฏูุซ `addReading()`: ุฅุถุงูุฉ userId ูููุฑุงุกุงุช ุงูุฌุฏูุฏุฉ
- โ ุชุญุฏูุซ `getCustomerReadings()`: ุชุตููุฉ ุญุณุจ userId
- โ ุชุญุฏูุซ `getAllReadings()`: ุชุตููุฉ ุญุณุจ userId
- โ ุชุญุฏูุซ `_createInvoiceForReading()`: ุฅุถุงูุฉ userId ููููุงุชูุฑ

#### โ `lib/screens/invoice_service.dart`

- โ ุญูู `AuthService` ูุงุนุชูุงุฏ
- โ ุชุญุฏูุซ `createInvoiceFromReading()`: ุฅุถุงูุฉ userId
- โ ุชุญุฏูุซ `getCustomerInvoices()`: ุชุตููุฉ ุญุณุจ userId
- โ ุชุญุฏูุซ `getAllInvoices()`: ุชุตููุฉ ุญุณุจ userId
- โ ุชุญุฏูุซ `getInvoiceStats()`: ุฅุญุตุงุฆูุงุช ุฎุงุตุฉ ุจุงููุณุชุฎุฏู ููุท

#### โ `lib/services/customer_service.dart`

- โ ุญูู `AuthService` ูุงุนุชูุงุฏ
- โ ุชุญุฏูุซ `addCustomer()`: ุฅุถุงูุฉ userId
- โ ุชุญุฏูุซ `getCustomers()`: ุชุตููุฉ ุญุณุจ userId

---

### 5. ูุงุฌูุงุช ุงููุณุชุฎุฏู (UI Screens)

#### โ `lib/screens/add_customer_screen_new.dart`

- โ ุงุณุชูุฑุงุฏ `AuthService`
- โ ุงูุญุตูู ุนูู userId ูุจู ุฅูุดุงุก ุงูุนููู
- โ ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู
- โ ุญูู userId ูู ูุงุฆู Customer

#### โ `lib/test_sync_screen.dart`

- โ ุงุณุชูุฑุงุฏ `AuthService`
- โ ุชุญุฏูุซ `_testAddCustomer()`: ุฅุถุงูุฉ userId ููุนููุงุก ุงูุชุฌุฑูุจููู
- โ ุชุญุฏูุซ `_testAddReading()`: ุฅุถุงูุฉ userId ูููุฑุงุกุงุช ุงูุชุฌุฑูุจูุฉ
- โ ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู ูุจู ุงูุงุฎุชุจุงุฑุงุช

---

## ๐ง ุงูุฃููุงุท ุงููุณุชุฎุฏูุฉ

### ููุท ุญูู userId

```dart
// 1. ุงูุญุตูู ุนูู AuthService
final authService = Provider.of<AuthService>(context, listen: false);

// 2. ุงูุญุตูู ุนูู userId
final userId = await authService.getCurrentUserId();

// 3. ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู
if (userId == null) {
  throw Exception('ูุง ููุฌุฏ ูุณุชุฎุฏู ูุณุฌู ุฏุฎูู');
}

// 4. ุงุณุชุฎุฏุงู userId ูู ุฅูุดุงุก ุงููุงุฆู
final customer = Customer(
  id: '...',
  userId: userId,  // โ ุญูู userId
  name: '...',
  // ...
);
```

### ููุท ุงูุชุตููุฉ ูู Repositories

```dart
// ุชุตููุฉ ุญุณุจ userId ูู ุงูุงุณุชุนูุงูุงุช
final customers = await db.query(
  'customers',
  where: 'userId = ? AND deleted = ?',
  whereArgs: [userId, 0],
);
```

### ููุท ุงูุชุตููุฉ ูู Firebase

```dart
// ุชุตููุฉ ุญุณุจ userId ูู Firebase
await for (var snapshot in _firestore
    .collection('customers')
    .where('userId', isEqualTo: userId)
    .snapshots()) {
  yield snapshot.docs.map(...).toList();
}
```

---

## ๐ ููุฒุงุช ุงูุฃูุงู ุงููุทุจูุฉ

1. โ **ุญูู userId ูู ุงูุฎุงุฏู**: ูุง ูุชู ูุจูู userId ูู ุงูุนูููุ ุจู ูุชู ุงูุญุตูู ุนููู ูู AuthService
2. โ **ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู**: ุฌููุน ุงูุนูููุงุช ุชุชุญูู ูู ูุฌูุฏ ูุณุชุฎุฏู ูุณุฌู
3. โ **ุชุตููุฉ ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**: ุงูุงุณุชุนูุงูุงุช ุชุตูู ุญุณุจ userId ูุจุงุดุฑุฉ
4. โ **ููุงุฑุณ ููุฃุฏุงุก**: ููุงุฑุณ ูุฑูุจุฉ (userId, deleted) ูุชุณุฑูุน ุงูุงุณุชุนูุงูุงุช
5. โ **ุงูุชูุงูู ูุน ุงูุจูุงูุงุช ุงููุฏููุฉ**: ููู ุงูุชุฑุงุถูุฉ 'default_user' ููุจูุงูุงุช ุงูููุฌูุฏุฉ

---

## โณ ุงูุฃุนูุงู ุงููุชุจููุฉ (TODO)

### 1. ุชุญุฏูุซ ุงููุงุฌูุงุช ุงููุชุจููุฉ

- โณ `lib/screens/add_customer_screen.dart` (ุงููุณุฎุฉ ุงููุฏููุฉ)
- โณ `lib/screens/add_reading_screen.dart`
- โณ ุฌููุน ูุงุฌูุงุช ุงูุชุนุฏูู (Edit Screens)

### 2. ุชุญุฏูุซ ุฎุฏูุฉ ุงููุฒุงููุฉ

- โณ `lib/services/sync_service.dart`: ุชุตููุฉ ุงูุจูุงูุงุช ุงููุฒุงููุฉ ุญุณุจ userId
- โณ ุงูุชุฃูุฏ ูู ูุฒุงููุฉ ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุญุงูู ููุท

### 3. ููุงุนุฏ ุฃูุงู Firebase

```javascript
// ูุฌุจ ุฅุถุงูุฉ ูุฐู ุงูููุงุนุฏ ูู Firebase Console
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /customers/{customerId} {
      allow read, write: if request.auth != null
        && request.auth.uid == resource.data.userId;
    }
    match /readings/{readingId} {
      allow read, write: if request.auth != null
        && request.auth.uid == resource.data.userId;
    }
    match /invoices/{invoiceId} {
      allow read, write: if request.auth != null
        && request.auth.uid == resource.data.userId;
    }
  }
}
```

### 4. ุงุฎุชุจุงุฑุงุช ุดุงููุฉ

- โณ ุงุฎุชุจุงุฑ ูุน ุญุณุงุจุงุช ูุณุชุฎุฏููู ูุชุนุฏุฏุฉ
- โณ ุงูุชุญูู ูู ุนุฏู ุธููุฑ ุจูุงูุงุช ูุณุชุฎุฏู ุขุฎุฑ
- โณ ุงุฎุชุจุงุฑ ุงููุถุน ุบูุฑ ุงููุชุตู
- โณ ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ ุนูุฏ ุงูุชุจุฏูู ุจูู ุงููุณุชุฎุฏููู

### 5. ุชุฑุญูู ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ

- โณ ุณูุฑูุจุช ูุชุนููู userId ุงูุตุญูุญ ููุจูุงูุงุช ุงูููุฌูุฏุฉ
- โณ ูุงุฌูุฉ ุฅุฏุงุฑูุฉ ูุฅุนุงุฏุฉ ุชุนููู ุงูุจูุงูุงุช ุงููุชููุฉ

---

## ๐ ุฅุญุตุงุฆูุงุช ุงูุชุญุฏูุซุงุช

- **ุนุฏุฏ ุงููููุงุช ุงููุญุฏุซุฉ**: 10 ูููุงุช
- **ุนุฏุฏ ุงูููุงุฐุฌ ุงููุญุฏุซุฉ**: 3 (Customer, Reading, Invoice)
- **ุนุฏุฏ ุงูุฎุฏูุงุช ุงููุญุฏุซุฉ**: 3 (ReadingService, InvoiceService, CustomerService)
- **ุนุฏุฏ ุงููุณุชูุฏุนุงุช ุงููุญุฏุซุฉ**: 1 (CustomerRepository)
- **ุนุฏุฏ ุงููุงุฌูุงุช ุงููุญุฏุซุฉ**: 2 (AddCustomerScreenNew, TestSyncScreen)
- **ุฅุตุฏุงุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช**: 2 โ 3

---

## ๐ฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. **ุงุฎุชุจุงุฑ ุงูุจูุงุก**: ุชุดุบูู `flutter run` ููุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก
2. **ุชุญุฏูุซ ุงููุงุฌูุงุช ุงููุชุจููุฉ**: ุฅููุงู ุชุญุฏูุซ ุฌููุน ูุงุฌูุงุช ุงูุฅุถุงูุฉ ูุงูุชุนุฏูู
3. **ุชุญุฏูุซ SyncService**: ุถูุงู ูุฒุงููุฉ ุจูุงูุงุช ุงููุณุชุฎุฏู ููุท
4. **ุฅุถุงูุฉ ููุงุนุฏ Firebase**: ุชุทุจูู ููุงุนุฏ ุงูุฃูุงู ุนูู Firebase
5. **ุงูุงุฎุชุจุงุฑ ุงูุดุงูู**: ุงุฎุชุจุงุฑ ูุน ูุณุชุฎุฏููู ูุชุนุฏุฏูู

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ**: ุงูุจูุงูุงุช ุงููุฏููุฉ ุณุชุญุตู ุนูู userId = 'default_user'
2. **ุงูุฃุฏุงุก**: ุงูููุงุฑุณ ุงููุฑูุจุฉ ุณุชุญุณู ุฃุฏุงุก ุงูุงุณุชุนูุงูุงุช ุจุดูู ูุจูุฑ
3. **ุงูุฃูุงู**: userId ูุชู ุญููู ูู AuthService ูููุณ ูู ุงููุณุชุฎุฏู
4. **ุงูุชูุงูู**: ุฌููุน ุงูุชุญุฏูุซุงุช ูุชูุงููุฉ ูุน ุงูุจูุงูุงุช ุงููุฏููุฉ

---

## โ ุงูุญุงูุฉ ุงูุญุงููุฉ

**ุงููุฑุญูุฉ ุงูุซุงููุฉ: ููุฏ ุงูุชูููุฐ - 70% ููุชูู**

- โ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ ูุญุฏุซุฉ
- โ ุงูููุงุฐุฌ ูุญุฏุซุฉ
- โ ุงููุณุชูุฏุนุงุช ุงูุฑุฆูุณูุฉ ูุญุฏุซุฉ
- โ ุงูุฎุฏูุงุช ุงูุฑุฆูุณูุฉ ูุญุฏุซุฉ
- โ ุจุนุถ ุงููุงุฌูุงุช ูุญุฏุซุฉ
- โณ ุจุงูู ุงููุงุฌูุงุช ุชุญุชุงุฌ ุชุญุฏูุซ
- โณ SyncService ูุญุชุงุฌ ุชุญุฏูุซ
- โณ ููุงุนุฏ Firebase ุชุญุชุงุฌ ุฅุถุงูุฉ
- โณ ุงูุงุฎุชุจุงุฑ ุงูุดุงูู ูุทููุจ
