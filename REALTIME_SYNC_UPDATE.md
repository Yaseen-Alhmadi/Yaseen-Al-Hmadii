# ๐ ุชุญุฏูุซ ูุธุงู ุงููุฒุงููุฉ ุงูููุฑูุฉ ููุนููุงุก

## ๐ ุงูููุฎุต

ุชู ุชุญุฏูุซ ุงูุชุทุจูู ูุถูุงู ุชุญุฏูุซ ุฌููุน ุงูุดุงุดุงุช ุชููุงุฆูุงู ุนูุฏ ุฅุถุงูุฉ ุฃู ุชุนุฏูู ุฃู ุญุฐู ุนูููุ ุจุงุณุชุฎุฏุงู **Stream** ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ (SQLite).

---

## โ ุงููุดููุฉ ุงูุชู ุชู ุญููุง

### **ูุจู ุงูุชุญุฏูุซ:**

- ุนูุฏ ุฅุถุงูุฉ ุนููู ุฌุฏูุฏุ ูุงูุช ุดุงุดุฉ **Dashboard** ุชุชุญุฏุซ ุชููุงุฆูุงู (ูุฃููุง ุชุณุชุฎุฏู Firestore Stream)
- ููู ุดุงุดุฉ **CustomersScreen** ูู ุชูู ุชุชุญุฏุซ (ูุฃููุง ุชุณุชุฎุฏู `FutureBuilder` ูุน ูุฑุงุกุฉ ูุญููุฉ)
- ูุงู ุงููุณุชุฎุฏู ูุญุชุงุฌ ููุนูุฏุฉ ูุฅุนุงุฏุฉ ูุชุญ ุงูุดุงุดุฉ ูุฑุคูุฉ ุงูุชุญุฏูุซุงุช

### **ุจุนุฏ ุงูุชุญุฏูุซ:**

- โ ุฌููุน ุงูุดุงุดุงุช ุชุชุญุฏุซ **ููุฑุงู** ุนูุฏ ุฃู ุชุบููุฑ (ุฅุถุงูุฉุ ุชุนุฏููุ ุญุฐู)
- โ ูุนูู **Offline** ุจุงููุงูู (ูุฑุงุกุฉ ูู SQLite ุงููุญููุฉ)
- โ ุฃุณุฑุน ูู ุงูุฃุฏุงุก (ูุง ุญุงุฌุฉ ููุงุชุตุงู ุจุงูุฅูุชุฑูุช ูุนุฑุถ ุงูุจูุงูุงุช)
- โ ุงููุฒุงููุฉ ูุน Firestore ุชุชู ูู ุงูุฎูููุฉ ุชููุงุฆูุงู

---

## ๐ง ุงูุชุบููุฑุงุช ุงูููููุฐุฉ

### **1๏ธโฃ ุชุญุฏูุซ `CustomerRepository`**

**ุงูููู:** `lib/repositories/customer_repository.dart`

#### **ุงูุชุบููุฑุงุช:**

```dart
// โ ุฅุถุงูุฉ Stream ููุนููุงุก ูู ุงููุงุนุฏุฉ ุงููุญููุฉ
Stream<List<Customer>> get customersStream async* {
  // ุฅุฑุณุงู ุงูุจูุงูุงุช ุงูุฃูููุฉ
  yield await getCustomers();

  // ุงูุงุณุชูุงุน ููุชุญุฏูุซุงุช
  await for (final _ in _syncController.stream) {
    yield await getCustomers();
  }
}
```

#### **ููู ูุนูู:**

1. ุนูุฏ ุงูุงุดุชุฑุงู ูู `customersStream`ุ ูุชู ุฅุฑุณุงู ุงูุจูุงูุงุช ุงูุฃูููุฉ ูู SQLite
2. ุนูุฏ ุฃู ุชุบููุฑ (ุฅุถุงูุฉ/ุชุนุฏูู/ุญุฐู)ุ ูุชู ุฅุทูุงู ุญุฏุซ ูู `_syncController`
3. `customersStream` ูุณุชูุน ููุฐู ุงูุฃุญุฏุงุซ ูููุฑุณู ุงูุจูุงูุงุช ุงููุญุฏุซุฉ ุชููุงุฆูุงู
4. ุฌููุน ุงูุดุงุดุงุช ุงููุดุชุฑูุฉ ูู ุงูู Stream ุชุชุญุฏุซ ููุฑุงู

---

### **2๏ธโฃ ุชุญุฏูุซ `CustomersScreen`**

**ุงูููู:** `lib/screens/customers_screen.dart`

#### **ุงูุชุบููุฑุงุช ุงูุฑุฆูุณูุฉ:**

**ูุจู:**

```dart
class CustomersScreen extends StatefulWidget {
  // ...
  late Future<List<Map<String, dynamic>>> _customersFuture;

  void _loadCustomers() {
    _customersFuture = customerService.getCustomersLocal();
  }

  // FutureBuilder - ูุง ูุชุญุฏุซ ุชููุงุฆูุงู
  FutureBuilder<List<Map<String, dynamic>>>(
    future: _customersFuture,
    // ...
  )
}
```

**ุจุนุฏ:**

```dart
class CustomersScreen extends StatelessWidget {
  // โ ูุง ุญุงุฌุฉ ูู State

  // โ StreamBuilder - ูุชุญุฏุซ ุชููุงุฆูุงู
  StreamBuilder<List<Customer>>(
    stream: customerRepo.customersStream,
    builder: (context, snapshot) {
      final customers = snapshot.data ?? [];
      // ...
    },
  )
}
```

#### **ุงูููุงุฆุฏ:**

- โ ุชุญูู ูู `StatefulWidget` ุฅูู `StatelessWidget` (ุฃุจุณุท ูุฃุฎู)
- โ ุฅุฒุงูุฉ `_loadCustomers()` - ูุง ุญุงุฌุฉ ูุฅุนุงุฏุฉ ุงูุชุญููู ูุฏููุงู
- โ ุงุณุชุฎุฏุงู `Customer` Model ุจุฏูุงู ูู `Map<String, dynamic>`
- โ ุชุญุฏูุซ ุชููุงุฆู ุนูุฏ ุฃู ุชุบููุฑ ูู ุงูุจูุงูุงุช
- โ ุชูุนูู ููุฒุฉ ุงูุญุฐู (ูุงูุช ูุนุทูุฉ ุณุงุจูุงู)

---

### **3๏ธโฃ ุชุญุฏูุซ `DashboardScreen`**

**ุงูููู:** `lib/screens/dashboard_screen.dart`

#### **ุงูุชุบููุฑุงุช:**

```dart
// ูุจู
final customerService = Provider.of<CustomerService>(context);
StreamBuilder<List<Map<String, dynamic>>>(
  stream: customerService.getCustomers(), // ูู Firestore
  // ...
)

// ุจุนุฏ
final customerRepo = Provider.of<CustomerRepository>(context, listen: false);
StreamBuilder<List<Customer>>(
  stream: customerRepo.customersStream, // ูู SQLite ุงููุญููุฉ
  // ...
)
```

#### **ุงูููุงุฆุฏ:**

- โ ูุฑุงุกุฉ ุฃุณุฑุน (ูู SQLite ุจุฏูุงู ูู Firestore)
- โ ูุนูู Offline
- โ ุชูุญูุฏ ูุตุฏุฑ ุงูุจูุงูุงุช ูุน ุจุงูู ุงูุดุงุดุงุช

---

## ๐ฏ ุขููุฉ ุงูุนูู ุงููุงููุฉ

### **ุนูุฏ ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ:**

```
1. ุงููุณุชุฎุฏู ูุถุบุท "ุฅุถุงูุฉ ุนููู" ูู AddCustomerScreen
   โ
2. customerRepo.addCustomer(newCustomer)
   โ
3. ุญูุธ ูู SQLite ุงููุญููุฉ + ูุถุน ุนูุงูุฉ pendingSync = 1
   โ
4. ุฅุทูุงู ุญุฏุซ ูู _syncController.add(null)
   โ
5. customersStream ูุณุชูุจู ุงูุญุฏุซ ูููุฑุณู ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
   โ
6. ุฌููุน ุงูุดุงุดุงุช (Dashboard, CustomersScreen) ุชุชุญุฏุซ ููุฑุงู โ
   โ
7. ูู ุงูุฎูููุฉ: ุฑูุน ุงูุจูุงูุงุช ุฅูู Firestore
   โ
8. ุชุญุฏูุซ pendingSync = 0 ูู SQLite
```

### **ุนูุฏ ุชููู ุชุญุฏูุซ ูู Firestore (ูู ุฌูุงุฒ ุขุฎุฑ):**

```
1. listenForRemoteUpdates() ูุณุชูุจู ุชุญุฏูุซ ูู Firestore
   โ
2. ุชุญุฏูุซ SQLite ุงููุญููุฉ
   โ
3. ุฅุทูุงู ุญุฏุซ ูู _syncController.add(null)
   โ
4. customersStream ููุฑุณู ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
   โ
5. ุฌููุน ุงูุดุงุดุงุช ุชุชุญุฏุซ ููุฑุงู โ
```

---

## ๐ ููุงุฑูุฉ ุงูุฃุฏุงุก

| ุงูููุฒุฉ                | ูุจู ุงูุชุญุฏูุซ          | ุจุนุฏ ุงูุชุญุฏูุซ          |
| --------------------- | -------------------- | -------------------- |
| **ุณุฑุนุฉ ุนุฑุถ ุงูุจูุงูุงุช** | ุจุทูุก (Firestore)     | ุณุฑูุน ุฌุฏุงู (SQLite)   |
| **ุงูุนูู Offline**     | โ Dashboard ูุง ูุนูู | โ ุฌููุน ุงูุดุงุดุงุช ุชุนูู |
| **ุงูุชุญุฏูุซ ุงูุชููุงุฆู**  | โ๏ธ Dashboard ููุท     | โ ุฌููุน ุงูุดุงุดุงุช      |
| **ุงุณุชููุงู ุงูุจูุงูุงุช**  | ุนุงูู                 | ููุฎูุถ ุฌุฏุงู           |
| **ุชุนููุฏ ุงูููุฏ**       | ูุชูุณุท                | ุจุณูุท ูููุธู           |

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### **ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ:**

1. **ุงุฎุชุจุงุฑ ุงูุฅุถุงูุฉ:**

   - ุงูุชุญ Dashboard โ ูุงุญุธ ุนุฏุฏ ุงูุนููุงุก
   - ุงุถุบุท "ุฅุถุงูุฉ ุนููู" โ ุฃุฏุฎู ุงูุจูุงูุงุช โ ุงุญูุธ
   - โ Dashboard ูุชุญุฏุซ ููุฑุงู ุจุฏูู ุฅุนุงุฏุฉ ูุชุญ ุงูุดุงุดุฉ
   - ุงูุชุญ "ุฅุฏุงุฑุฉ ุงูุนููุงุก"
   - โ ุงูุนููู ุงูุฌุฏูุฏ ูุธูุฑ ูู ุงููุงุฆูุฉ

2. **ุงุฎุชุจุงุฑ ุงูุญุฐู:**

   - ุงูุชุญ "ุฅุฏุงุฑุฉ ุงูุนููุงุก"
   - ุงุถุบุท ุนูู ูุงุฆูุฉ ุนููู โ "ุญุฐู"
   - โ ุงูุนููู ูุฎุชูู ูู ุงููุงุฆูุฉ ููุฑุงู
   - ุงุฑุฌุน ููู Dashboard
   - โ ุนุฏุฏ ุงูุนููุงุก ูุชุญุฏุซ ุชููุงุฆูุงู

3. **ุงุฎุชุจุงุฑ Offline:**

   - ุงูุตู ุงูุฅูุชุฑูุช
   - ุงูุชุญ ุงูุชุทุจูู
   - โ ุฌููุน ุงูุจูุงูุงุช ุชุธูุฑ ุจุดูู ุทุจูุนู
   - ุฃุถู ุนููู ุฌุฏูุฏ
   - โ ููุญูุธ ูุญููุงู ููุธูุฑ ูู ุฌููุน ุงูุดุงุดุงุช
   - ุฃุนุฏ ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช
   - โ ูุชู ุฑูุน ุงูุจูุงูุงุช ุชููุงุฆูุงู ุฅูู Firestore

4. **ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ ูู ุฌูุงุฒ ุขุฎุฑ:**
   - ุณุฌู ุฏุฎูู ุจููุณ ุงูุญุณุงุจ ุนูู ุฌูุงุฒูู
   - ุฃุถู ุนููู ูู ุงูุฌูุงุฒ ุงูุฃูู
   - โ ูุธูุฑ ุชููุงุฆูุงู ุนูู ุงูุฌูุงุฒ ุงูุซุงูู

---

## ๐ ุงููููุงุช ุงูููุนุฏูุฉ

```
lib/
โโโ repositories/
โ   โโโ customer_repository.dart      โ ุฅุถุงูุฉ customersStream
โโโ screens/
โ   โโโ customers_screen.dart         โ ุชุญููู ูู StreamBuilder
โ   โโโ dashboard_screen.dart         โ ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุญููุฉ
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

### **1. ููุงุฐุง SQLite ุจุฏูุงู ูู Firestore ูุจุงุดุฑุฉุ**

- โ **ุฃุณุฑุน:** ูุฑุงุกุฉ ูุญููุฉ ููุฑูุฉ
- โ **Offline:** ูุนูู ุจุฏูู ุฅูุชุฑูุช
- โ **ุฃูู ุชูููุฉ:** ุชูููู ุนุฏุฏ ุงููุฑุงุกุงุช ูู Firestore
- โ **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู:** ูุง ุงูุชุธุงุฑ ููุชุญููู

### **2. ููู ุชุชู ุงููุฒุงููุฉ ูุน Firestoreุ**

- **ุนูุฏ ุงูุฅุถุงูุฉ/ุงูุชุนุฏูู:** ูุชู ุงูุฑูุน ุชููุงุฆูุงู ูู ุงูุฎูููุฉ
- **ุนูุฏ ุงูุงุณุชูุงุน:** `listenForRemoteUpdates()` ูุณุชูุจู ุงูุชุญุฏูุซุงุช ูู Firestore
- **ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู:** `syncAll()` ูุณุญุจ ุฌููุน ุงูุจูุงูุงุช

### **3. ูุงุฐุง ูู ุญุฏุซ ุชุนุงุฑุถุ**

- ูุชู ููุงุฑูุฉ `lastModified` timestamp
- ุงูุฃุญุฏุซ ูููุฒ (Last Write Wins)
- ุงูุณุฌูุงุช ุงููุญููุฉ ูู ุงูุชุธุงุฑ ุงููุฒุงููุฉ (`pendingSync = 1`) ูุง ูุชู ุงุณุชุจุฏุงููุง

---

## ๐ ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ ุงูููุชุฑุญุฉ

1. **ุฅุถุงูุฉ Stream ูููุฑุงุกุงุช ูุงูููุงุชูุฑ:**

   - ุชุทุจูู ููุณ ุงูููุท ุนูู `ReadingRepository` ู `InvoiceRepository`

2. **ุฅุถุงูุฉ ูุคุดุฑ ุญุงูุฉ ุงููุฒุงููุฉ:**

   - ุนุฑุถ ุฃููููุฉ ุชุฏู ุนูู ุฃู ููุงู ุจูุงูุงุช ูู ุงูุชุธุงุฑ ุงููุฒุงููุฉ

3. **ุฅุถุงูุฉ Pull-to-Refresh:**

   - ุงูุณูุงุญ ูููุณุชุฎุฏู ุจุณุญุจ ุงูุดุงุดุฉ ูุฅุนุงุฏุฉ ุงููุฒุงููุฉ ูุฏููุงู

4. **ุฅุถุงูุฉ Conflict Resolution UI:**

   - ุนุฑุถ ูุงุฌูุฉ ูููุณุชุฎุฏู ุนูุฏ ุญุฏูุซ ุชุนุงุฑุถ ูู ุงูุจูุงูุงุช

5. **ุชุญุณูู ุงูุฃุฏุงุก:**
   - ุงุณุชุฎุฏุงู `debounce` ูุชูููู ุนุฏุฏ ุงูุชุญุฏูุซุงุช ุงููุชุชุงููุฉ

---

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:

1. ุชุญูู ูู ุฑุณุงุฆู Debug ูู Console
2. ุชุฃูุฏ ูู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ
3. ุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช ูููุฒุงููุฉ ูุน Firestore
4. ุฑุงุฌุน ููู `CONVERSATION_SUMMARY.md` ููุชูุงุตูู ุงููุงููุฉ

---

**ุชุงุฑูุฎ ุงูุชุญุฏูุซ:** 2024
**ุงูุฅุตุฏุงุฑ:** 1.1.0
**ุงูุญุงูุฉ:** โ ููุฎุชุจุฑ ูุฌุงูุฒ ููุฅูุชุงุฌ
