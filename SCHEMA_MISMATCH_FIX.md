# ุฅุตูุงุญ ุนุฏู ุชุทุงุจู ุงูุจููุฉ ุจูู Firebase ู SQLite

## ๐ ุงููุดููุฉ

ุจุนุฏ ุฅุตูุงุญ ูุดููุฉ Timestampุ ุธูุฑุช ูุดููุฉ ุฌุฏูุฏุฉ:

```
DatabaseException: table customers has no column named initialReading
```

### ุงูุณุจุจ ุงูุฌุฐุฑู

- ุจูุงูุงุช Firebase ุชุญุชูู ุนูู ุญููู ุฅุถุงููุฉ (ูุซู `initialReading`) ุบูุฑ ููุฌูุฏุฉ ูู:

  1. ูููุฐุฌ `Customer` ุงููุญูู
  2. ุฌุฏูู `customers` ูู SQLite

- ุนูุฏ ูุญุงููุฉ ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช ูู Firebase ุฅูู SQLiteุ ูุญุงูู ุงููุธุงู ุฅุฏุฑุงุฌ ุฌููุน ุงูุญููู ุจูุง ูููุง ุงูุญููู ุบูุฑ ุงููุฏุนููุฉ

## โ ุงูุญู ุงููุทุจู

### 1. ุฅุถุงูุฉ ุฏุงูุฉ ุชูุธูู ุงูุจูุงูุงุช

ุชู ุฅุถุงูุฉ ุฏุงูุฉ `_cleanCustomerData()` ูู `customer_repository.dart`:

```dart
/// ุชูุธูู ุงูุจูุงูุงุช ูู ุงูุญููู ุบูุฑ ุงููุฏุนููุฉ
Map<String, dynamic> _cleanCustomerData(Map<String, dynamic> data) {
  // ูุงุฆูุฉ ุงูุญููู ุงููุฏุนููุฉ ูู ุฌุฏูู customers
  const supportedFields = {
    'id',
    'name',
    'phone',
    'address',
    'meterNumber',
    'lastReading',
    'lastReadingDate',
    'status',
    'createdAt',
    'lastModified',
    'lastSyncedAt',
    'pendingSync',
    'deleted',
  };

  // ุฅุฒุงูุฉ ุงูุญููู ุบูุฑ ุงููุฏุนููุฉ
  final cleaned = <String, dynamic>{};
  data.forEach((key, value) {
    if (supportedFields.contains(key)) {
      cleaned[key] = value;
    }
  });

  return cleaned;
}
```

### 2. ุชุทุจูู ุงูุชูุธูู ูู ุฌููุน ุนูููุงุช ุงูุฅุฏุฑุงุฌ/ุงูุชุญุฏูุซ

#### ูู `pullRemoteChanges()`:

**ูุจู:**

```dart
await _dbHelper.insert('customers', {
  ...remote,
  'pendingSync': 0,
  'lastSyncedAt': DateTime.now().toIso8601String(),
  'deleted': remote['deleted'] ?? 0,
});
```

**ุจุนุฏ:**

```dart
final cleanData = _cleanCustomerData({
  ...remote,
  'pendingSync': 0,
  'lastSyncedAt': DateTime.now().toIso8601String(),
  'deleted': remote['deleted'] ?? 0,
});
await _dbHelper.insert('customers', cleanData);
```

#### ูู `listenForRemoteUpdates()`:

ุชู ุชุทุจูู ููุณ ุงูููุทู ูู:

- ุฅุถุงูุฉ ุณุฌู ุฌุฏูุฏ (realtime)
- ุชุญุฏูุซ ุณุฌู ููุฌูุฏ

## ๐ฏ ุงูููุงุฆุฏ

### 1. **ุงููุฑููุฉ ูู ุงูุจููุฉ**

- ูููู ุฅุถุงูุฉ ุญููู ุฌุฏูุฏุฉ ูู Firebase ุฏูู ุงูุชุฃุซูุฑ ุนูู ุงูุชุทุจูู ุงููุญูู
- ูุง ุญุงุฌุฉ ูุชุญุฏูุซ ุจููุฉ SQLite ุนูุฏ ูู ุชุบููุฑ ูู Firebase

### 2. **ุงูุฃูุงู**

- ููุน ูุญุงููุฉ ุฅุฏุฑุงุฌ ุจูุงูุงุช ุบูุฑ ูุชูุงููุฉ
- ุชุฌูุจ ุฃุฎุทุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช

### 3. **ุณูููุฉ ุงูุตูุงูุฉ**

- ูุงุฆูุฉ ูุงุถุญุฉ ุจุงูุญููู ุงููุฏุนููุฉ ูู ููุงู ูุงุญุฏ
- ุณูููุฉ ุฅุถุงูุฉ/ุฅุฒุงูุฉ ุญููู ูุฏุนููุฉ

## ๐ ุงูุญููู ุงููุฏุนููุฉ ุญุงููุงู

| ุงูุญูู             | ุงูููุน   | ุงููุตู                    |
| ----------------- | ------- | ------------------------ |
| `id`              | TEXT    | ุงููุนุฑู ุงููุฑูุฏ            |
| `name`            | TEXT    | ุงุณู ุงูุนููู               |
| `phone`           | TEXT    | ุฑูู ุงููุงุชู               |
| `address`         | TEXT    | ุงูุนููุงู                  |
| `meterNumber`     | TEXT    | ุฑูู ุงูุนุฏุงุฏ               |
| `lastReading`     | REAL    | ุขุฎุฑ ูุฑุงุกุฉ                |
| `lastReadingDate` | TEXT    | ุชุงุฑูุฎ ุขุฎุฑ ูุฑุงุกุฉ          |
| `status`          | TEXT    | ุงูุญุงูุฉ (active/inactive) |
| `createdAt`       | TEXT    | ุชุงุฑูุฎ ุงูุฅูุดุงุก            |
| `lastModified`    | TEXT    | ุชุงุฑูุฎ ุขุฎุฑ ุชุนุฏูู          |
| `lastSyncedAt`    | TEXT    | ุชุงุฑูุฎ ุขุฎุฑ ูุฒุงููุฉ         |
| `pendingSync`     | INTEGER | ูู ุงูุชุธุงุฑ ุงููุฒุงููุฉ       |
| `deleted`         | INTEGER | ูุญุฐูู (0/1)              |

## ๐ ุงูุญููู ุงููุชุฌุงููุฉ ูู Firebase

ุงูุญููู ุงูุชุงููุฉ ููุฌูุฏุฉ ูู Firebase ููู ูุชู ุชุฌุงูููุง:

- `initialReading` - ุงููุฑุงุกุฉ ุงูุฃูููุฉ
- ุฃู ุญููู ูุฎุตุตุฉ ุฃุฎุฑู

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงูุณููุงุฑูู 1: ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ ูู Firebase

```
โ ูุจู: ุฎุทุฃ "table customers has no column named initialReading"
โ ุจุนุฏ: ุชู ุฅุถุงูุฉ ุงูุนููู ุจูุฌุงุญ (ุชุฌุงูู initialReading)
```

### ุงูุณููุงุฑูู 2: ุชุญุฏูุซ ุนููู ููุฌูุฏ

```
โ ูุจู: ุฎุทุฃ ุนูุฏ ูุญุงููุฉ ุชุญุฏูุซ ุญููู ุบูุฑ ููุฌูุฏุฉ
โ ุจุนุฏ: ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ (ููุท ุงูุญููู ุงููุฏุนููุฉ)
```

### ุงูุณููุงุฑูู 3: ุงููุฒุงููุฉ ูู ุงูููุช ุงููุนูู

```
โ ูุจู: ุฎุทุฃ ุนูุฏ ุงุณุชูุจุงู ุชุญุฏูุซุงุช ุชุญุชูู ุนูู ุญููู ุฅุถุงููุฉ
โ ุจุนุฏ: ุชู ุงุณุชูุจุงู ุงูุชุญุฏูุซุงุช ุจูุฌุงุญ
```

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

### `lib/repositories/customer_repository.dart`

- โ ุฅุถุงูุฉ ุฏุงูุฉ `_cleanCustomerData()`
- โ ุชุทุจูู ุงูุชูุธูู ูู `pullRemoteChanges()` (3 ููุงุถุน)
- โ ุชุทุจูู ุงูุชูุธูู ูู `listenForRemoteUpdates()` (2 ููุงุถุน)

## ๐ฎ ุงูุชูุตูุงุช ุงููุณุชูุจููุฉ

### 1. ุฅุถุงูุฉ ุญูู `initialReading` ุฅูู ุงููุธุงู ุงููุญูู

ุฅุฐุง ูุงู ุงูุญูู ูููุงูุ ูููู ุฅุถุงูุชู:

**ูู `database_helper.dart`:**

```dart
await db.execute('''
  CREATE TABLE customers (
    ...
    initialReading REAL DEFAULT 0.0,
    ...
  )
''');
```

**ูู `customer_model.dart`:**

```dart
class Customer {
  ...
  final double initialReading;
  ...
}
```

**ูู `customer_repository.dart`:**

```dart
const supportedFields = {
  ...
  'initialReading',
  ...
};
```

### 2. ุชุทุจูู ููุณ ุงูููุทู ุนูู `reading_repository.dart`

ุฅุฐุง ูุงูุช ุฌุฏุงูู ุฃุฎุฑู ุชูุงุฌู ููุณ ุงููุดููุฉุ ูููู ุชุทุจูู ููุณ ุงูุญู.

### 3. ุงุณุชุฎุฏุงู Schema Validation

ูููู ุฅุถุงูุฉ ุทุจูุฉ validation ููุชุฃูุฏ ูู ุชูุงูู ุงูุจูุงูุงุช ูุจู ุงูุฅุฏุฑุงุฌ.

## ๐ ุงูุฏุฑูุณ ุงููุณุชูุงุฏุฉ

1. **ุนุฏู ุชุทุงุจู ุงูุจููุฉ ุดุงุฆุน** ูู ุฃูุธูุฉ ุงููุฒุงููุฉ ุจูู ููุงุนุฏ ุจูุงูุงุช ูุฎุชููุฉ
2. **ุงูุชูุธูู ุงูููุงุฆู** ุฃูุถู ูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
3. **ุงููุงุฆูุฉ ุงูุจูุถุงุก** (whitelist) ุฃูุซุฑ ุฃูุงูุงู ูู ุงููุงุฆูุฉ ุงูุณูุฏุงุก (blacklist)
4. **ุงูุชูุซูู ุงููุงุถุญ** ููุญููู ุงููุฏุนููุฉ ูุณูู ุงูุตูุงูุฉ

## โ ุงูุญุงูุฉ ุงูููุงุฆูุฉ

- โ ุชู ุฅุตูุงุญ ูุดููุฉ Timestamp
- โ ุชู ุฅุตูุงุญ ูุดููุฉ ุนุฏู ุชุทุงุจู ุงูุจููุฉ
- โ ุงููุฒุงููุฉ ุชุนูู ุจูุฌุงุญ
- โ ุงููุธุงู ูุชุฌุงูู ุงูุญููู ุบูุฑ ุงููุฏุนููุฉ ุชููุงุฆูุงู

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 2024
**ุงููุทูุฑ:** AI Assistant
**ุงูุญุงูุฉ:** โ ููุชูู ููุฎุชุจุฑ
